<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="com.ssafy.pjt.repository.mapper.EvaluationMapper">
	<!--방의 맴버 조회 -->
	<select id="seachEvaluation" parameterType="int"
		resultType="Evaluation">
		SELECT *
		FROM evaluation e
		RIGHT JOIN entrant t
		ON e.eid = t.eid
		JOIN room r
		ON r.rid = t.rid
		WHERE e.eid = #{eid}
		AND (DATE_FORMAT(e.attend_time,'%H:%i:%s') BETWEEN
		DATE_FORMAT(r.start_time ,'%H:%i:%s') AND DATE_FORMAT(r.end_time
		,'%H:%i:%s'))
		AND DATE(NOW()) = DATE(e.attend_time);
	</select>
	<select id="roomEntrantInfo" parameterType="insertRoomEvaluationDto"
		resultType="findEntrantInfo">
		select m.uid, m.name, m.email, ev.vid, ev.eid, ev.eval_date, ev.attention, ev.participation, ev.distracted, ev.asleep, ev.afk, ev.attend_time, ev.ranking, ev.attend
		from member m join entrant e
		on m.uid = e.uid and e.rid = #{rid}
		join evaluation ev
		on e.eid = ev.eid
		<trim prefix="where" suffixOverrides="or"  suffix=";">
			<if test= "isLate == 1">ev.attend = "정상" or</if>
			<if test= "isAbsent == 1">ev.attend = "지각" or</if>
			<if test= "isAttendFist == 1">ev.ranking=1 or</if>
			<if test= "isChatFirst == 1">ev.participation = (select max(evv.participation) 
										from room rr join entrant ee 
										on ee.rid = rr.rid
										join evaluation evv 
										on ee.eid = evv.eid
										where rr.rid = #{rid}) or</if>
		</trim>
	</select>

</mapper>